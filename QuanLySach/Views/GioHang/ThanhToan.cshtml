@using QuanLySach.Models
@model QuanLySach.Models.thongTinKH

<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport"
          content="width=device-width, initial-scale=1.0, shrink-to-fit=no" />
    <link rel="icon" href="/assets/img/bookstore.ico" type="image/x-icon" />
    <title>Thanh Toán</title>
    <link rel="stylesheet" href="/assets/bootstrap/css/bootstrap.min.css" />
    <link rel="stylesheet"
          href="https://fonts.googleapis.com/css?family=Inter:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800&amp;display=swap" />
    <link rel="stylesheet" href="/assets/fonts/fontawesome-all.min.css" />
    <link rel="stylesheet" href="/assets/fonts/simple-line-icons.min.css" />
    <link rel="stylesheet" href="/assets/css/Hero-Clean-Reverse.css" />
    <link rel="stylesheet"
          href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.5.2/animate.min.css" />
    <link rel="stylesheet"
          href="https://cdnjs.cloudflare.com/ajax/libs/aos/2.3.4/aos.css" />
    <link rel="stylesheet"
          href="https://cdnjs.cloudflare.com/ajax/libs/Swiper/6.4.8/swiper-bundle.min.css" />
    <link rel="stylesheet" href="/assets/css/Light-Contact-List.css" />
    <link rel="stylesheet" href="assets/css/Login-with-overlay-image.css" />
    <link rel="stylesheet" href="/assets/css/Pretty-Product-List.css" />
    <link rel="stylesheet" href="/assets/css/Simple-Slider.css" />
    <link rel="stylesheet" href="/assets/css/style.css" />
    <link rel="stylesheet" href="/assets/css/Team.css" />
</head>

<body style="
      /*background: url(&quot;design.jpg&quot;);*/
      background-position: 0 -60px;
    ">
    <div class="container header">
        @Html.Action("HeaderKH", "Layout")
        <section class="py-4 py-xl-5"></section>
        <div class="text-center p-4 p-lg-5">
            <h1 class="fw-bold mb-4" style="font-family: EB Garamond; font-size: 116px; transform: translate(76px)">THANH TOÁN</h1>

            <div class="float-start"
                 style="
            margin: 0px;
            padding: 0px;
            width: 1267px;
            font-family: Heebo;
            text-align: justify;
            transform: translate(190px);
          ">
                <div class="checkout-wrapper__left-side">
                    <form id="checkout-form"
                          novalidate="novalidate"
                          class="cm-processed-form">
                        <div class="checkout-process">
                            <h3>Chọn hình thức thanh toán</h3>
                            <div class="checkout-step step-2 collapse-component">
                                <div class="payment-method-wrapper">
                                    <div class="place-shipping-item">
                                        <label for="paymentCOD" class="label-block">
                                            <input type="radio"
                                                   name="payment_method"
                                                   class="custom-radio collapse-radio"
                                                   id="paymentCOD"
                                                   value="2"
                                                   checked=""
                                                   onclick="togglePaymentForm('cod')" />
                                            <div class="place-shipping-box">
                                                <div class="radio-box">
                                                    <div class="custom-radio-1-box">
                                                        <div class="custom-radio-1"></div>
                                                    </div>
                                                </div>
                                                <img loading="lazy"
                                                     class="place-shipping-image unchecked"
                                                     width="73"
                                                     height="36"
                                                     src="/assets/img/thanhtoankhinhanhang.png"
                                                     alt="payment-method-COD" />
                                                <img loading="lazy"
                                                     class="place-shipping-image checked"
                                                     width="73"
                                                     height="36"
                                                     src="/assets/img/thanhtoankhinhanhang.png"
                                                     alt="payment-method-COD" />
                                                <p class="place-shipping-title">
                                                    Thanh toán khi nhận hàng
                                                </p>
                                            </div>
                                        </label>
                                    </div>

                                    <div class="place-shipping-item">
                                        <label for="paymentInternetBanking" class="label-block">
                                            <input type="radio"
                                                   name="payment_method"
                                                   class="custom-radio collapse-radio"
                                                   value="1"
                                                   data-collapse-wrapper="payment-internet-banking"
                                                   id="paymentInternetBanking"
                                                   onclick="togglePaymentForm('internetBanking')" />
                                            <div class="place-shipping-box">
                                                <div class="radio-box">
                                                    <div class="custom-radio-1-box">
                                                        <div class="custom-radio-1"></div>
                                                    </div>
                                                </div>
                                                <img loading="lazy"
                                                     class="place-shipping-image unchecked"
                                                     width="73"
                                                     height="36"
                                                     src="/assets/img/thanh-toan-bang-internet-banking-2.jpg"
                                                     alt="payment-method-internet-banking" />
                                                <img loading="lazy"
                                                     class="place-shipping-image checked"
                                                     width="73"
                                                     height="36"
                                                     src="/assets/img/thanh-toan-bang-internet-banking-2.jpg"
                                                     alt="payment-method-internet-banking" />
                                                <p class="place-shipping-title">
                                                    Thanh toán VNPAY
                                                </p>
                                            </div>
                                        </label>
                                    </div>
                                </div>
                                @if (Session["payment"].ToString().Contains("thành công"))
                                {
                                    <div style="color: green">Thanh toán VNPay Thành công<br /></div> 
                                }
                                else if (Session["payment"].ToString().Contains("lỗi"))
                                {
                                    <div style="color: red">Thanh toán VNPay Thất bại<br /></div>
                                }
                                <form id="checkout-form" novalidate="novalidate">

                                    <div class="placeAtHomeInfo radio-collapse-wrapper collapse-wrapper-show"
                                         id="place-at-home">

                                        <div class="address-shipping-wrapper Register_account" id="address-shipping-wrapper">
                                            <div class="form-group">
                                                <div class="input-wrapper">
                                                    <span class="input-wrapper__label mini">Họ và tên <em>(*)</em></span>
                                                    @Html.TextBoxFor(m => m.HoTen, "", new { @class = "form-control", @name = "HoTen", @placeholder = "Họ Và Tên" })
                                                </div>
                                                @Html.ValidationMessageFor(m => m.HoTen, "", new { @class = "text-danger" })
                                            </div>
                                            <div class="form-group">
                                                <div class="input-wrapper">
                                                    <span class="input-wrapper__label mini">Số điện thoại <em>(*)</em></span>
                                                    @Html.TextBoxFor(m => m.SoDienThoai, "", new { @class = "form-control", @name = "SoDienThoai", @placeholder = "Số Điện Thoại" })
                                                </div>
                                                @Html.ValidationMessageFor(m => m.SoDienThoai, "", new { @class = "text-danger" })
                                            </div>
                                            <div class="form-group" id="emailField">
                                                <div class="input-wrapper">
                                                    <span class="input-wrapper__label mini" for="email">Email</span>
                                                    @Html.TextBoxFor(m => m.Email, "", new { @class = "form-control", @name = "Email", @placeholder = "Email" })
                                                </div>
                                            </div>
                                            <div class="form-group street" id="addressField">
                                                <div class="input-wrapper">
                                                    <span class="input-wrapper__label">Địa chỉ (Số Nhà, Tên đường, Xã/Huyện, Thành Phố) <em>(*)</em></span>
                                                    @Html.TextBoxFor(m => m.DiaChi, "", new { @class = "form-control", @name = "DiaChi", @placeholder = "Địa Chỉ" })
                                                </div>
                                                @Html.ValidationMessageFor(m => m.DiaChi, "", new { @class = "text-danger" })
                                            </div>
                                        </div>


                                        <label for="register_account"
                                               class="label-block Register_account"
                                               style="margin: 5px 0 0">

                                            <div class="export-billing-box confirm-installation-box"
                                                 style="border: 0; padding: 0; font-size: 15px">
                                            </div>
                                        </label>
                                        <div class="delivery-date-time-section" id="note_order">
                                            <div class="input-wrapper">
                                                <span class="input-wrapper__label">Để lại lời nhắn cho Bookstore</span>
                                                <textarea name="note"
                                                          aria-label="delivery note"
                                                          rows="3"
                                                          style="width: 100%"></textarea>
                                            </div>
                                        </div>
                                    </div>


                                    <div class="placeAtStoreInfo radio-collapse-wrapper"
                                         id="place-at-store">
                                        <div class="place-at-store-wrapper">
                                            <div class="place-at-store-select">
                                                <div class="input-wrapper">
                                                    <span class="input-wrapper__label mini">Chọn Tỉnh/Thành Phố</span>
                                                    <select name="list-province"
                                                            class="custom-select form-select label-mini"
                                                            aria-label="select province"
                                                            id="store-city"></select>
                                                </div>
                                                <div class="input-wrapper">
                                                    <span class="input-wrapper__label mini">Chọn Quận/Huyện</span>
                                                    <select name="list-store-filter"
                                                            class="custom-select form-select label-mini"
                                                            aria-label="select district"
                                                            id="store-district"></select>
                                                </div>
                                            </div>
                                            <div class="list-store" id="store-list"></div>
                                        </div>
                                    </div>
                                    <h3>Chọn địa chỉ nhận hàng</h3>
                                    <!--Chọn các bước-->

                                    <div class="checkout-step collapse-component step-1">
                                        <div class="place-shipping-wrapper">
                                            <div class="place-shipping-item">
                                                <label for="placeAtStore" class="label-block">
                                                    <input type="radio"
                                                           name="delivery_type"
                                                           class="custom-radio collapse-radio"
                                                           id="placeAtStore"
                                                           data-collapse-wrapper="place-at-store"
                                                           value="1"
                                                           onclick="toggleFields()" />
                                                    <div class="place-shipping-box">
                                                        <div class="radio-box">
                                                            <div class="custom-radio-1-box">
                                                                <div class="custom-radio-1"></div>
                                                            </div>
                                                        </div>
                                                        <img loading="lazy"
                                                             class="place-shipping-image unchecked"
                                                             width="73"
                                                             height="36"
                                                             src="/assets/img/logo-xetai.jpg"
                                                             alt="icon-nk-delivery" />
                                                        <img loading="lazy"
                                                             class="place-shipping-image checked"
                                                             width="73"
                                                             height="36"
                                                             src="/assets/img/logo-xetai-Photoroom.jpg"
                                                             alt="icon-nk-delivery" />
                                                        <p class="place-shipping-title">Nhận hàng tại trung tâm</p>
                                                    </div>
                                                </label>
                                            </div>

                                            <div class="place-shipping-item">
                                                <label for="placeAtHome" class="label-block">
                                                    <input type="radio"
                                                           name="delivery_type"
                                                           class="custom-radio collapse-radio"
                                                           id="placeAtHome"
                                                           value="2"
                                                           onclick="toggleFields()" />
                                                    <div class="place-shipping-box active">
                                                        <div class="radio-box">
                                                            <div class="custom-radio-1-box">
                                                                <div class="custom-radio-1"></div>
                                                            </div>
                                                        </div>
                                                        <img loading="lazy"
                                                             class="place-shipping-image unchecked lazyload"
                                                             width="54"
                                                             height="36"
                                                             data-src=""
                                                             alt="icon-nk-delivery"
                                                             src="/assets/img/logo-giaohang.png" />
                                                        <img loading="lazy"
                                                             class="place-shipping-image checked lazyloaded"
                                                             width="54"
                                                             height="36"
                                                             data-src=""
                                                             alt="icon-nk-delivery"
                                                             src="/assets/img/logo-giaohang.png" />
                                                        <p class="place-shipping-title">Nhận hàng tại nhà</p>
                                                    </div>
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="checkout-step step-3 collapse-component collapse-component">
                                        <label for="confirmPolicy" class="label-block mb-3">
                                            <input type="checkbox"
                                                   class="custom-checkbox"
                                                   id="confirmPolicy"
                                                   name="confirmPolicy"
                                                   checked="" />
                                            <div class="export-billing-box confirm-policy-box">
                                                <div class="custom-checkbox-wrapper">
                                                    <div class="custom-checkbox-box"></div>
                                                </div>
                                                <div>
                                                    Tôi đồng ý
                                                    <a href="/" target="_blank" class="policy-link">thoả thuận bảo mật và chính sách mua hàng</a>
                                                    của
                                                    <span class="text-red">BookStore</span>
                                                </div>
                                            </div>
                                        </label>

                                    </div>

                                    <p class="note-checkout">
                                        "Lưu ý: BookStore chỉ giao hàng đối với các địa chỉ giao hàng
                                        có khoảng cách ít hơn hoặc bằng 500km tính từ trung tâm tiếp
                                        nhận đơn hàng và đáp ứng đủ điều kiện vận chuyển của
                                        BookStore. Trường hợp sản phẩm bạn chọn không có sẵn hàng tại
                                        khu vực gần bạn, việc giao hàng sẽ được thực hiện bởi đối tác
                                        của BookStore và không hỗ trợ lắp đặt (nếu có)."
                                    </p>


                                    <div class="checkout-box">

                                        <button type="submit"
                                                class="checkout_buy button checkout-cta buy_now" runat="server" OnClick="btnPay_Click">
                                            Thanh toán
                                        </button>


                                    </div>
                            </div>
                    </form>
                    <!-- Khu vực hiển thị thông báo -->
                    <div id="message-area" class="mt-3"></div>
                </div>
            </div>
        </div>
    </div>

    <script src="/assets/js/jquery.min.js"></script>
    <script src="/assets/bootstrap/js/bootstrap.min.js"></script>
    <script src="/assets/js/bs-init.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/aos/2.3.4/aos.js"></script>
    <script src="/assets/js/basket.js"></script>
    <script src="/assets/js/bold-and-bright.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Swiper/6.4.8/swiper-bundle.min.js"></script>
    <script src="/assets/js/login.js"></script>
    <script src="/assets/js/price.js"></script>
    <script src="/assets/js/Simple-Slider.js"></script>
    <script>
    function toggleFields() {
        const isPlaceAtStore = document.querySelector('input[name="delivery_type"][value="1"]').checked;
        const emailField = document.getElementById("emailField");
        const addressField = document.getElementById("addressField");

        if (isPlaceAtStore) {
            emailField.style.display = "none";
            addressField.style.display = "none";
        } else {
            emailField.style.display = "block";
            addressField.style.display = "block";
        }
    }

    // Gọi hàm khi người dùng thay đổi tùy chọn giao hàng
    document.querySelectorAll('input[name="delivery_type"]').forEach((radio) => {
        radio.addEventListener('change', toggleFields);
    });

    // Đảm bảo trạng thái ban đầu khi trang tải
    window.onload = toggleFields;
    </script>

    <script>
    // Hoặc nếu muốn lắng nghe sự kiện khi chọn radio button
    $('#paymentInternetBanking').change(function() {
        if (this.checked) {
            window.location.href = '@Url.Action("Payment", "GioHang")';
        }
    });
    </script>

    <script>
    $(document).ready(function () {
        $('#checkout-form').on('submit', function (event) {
            event.preventDefault(); // Ngăn việc tải lại trang

            // Tạo một đối tượng FormData từ form
            let formData = new FormData(this);

            // Kiểm tra dữ liệu trong FormData
            for (let pair of formData.entries()) {
                console.log(pair[0] + ': ' + pair[1]);
            }

            $.ajax({
                url: '@Url.Action("ThanhToanND", "GioHang")', // URL đến action "ThanhToanND"
                type: 'POST',
                data: formData,
                 processData: false, // Ngăn jQuery xử lý dữ liệu
                contentType: false, // Đặt thành false để jQuery tự động xử lý
                success: function (response) {
                    let messageArea = $('#message-area');
                    messageArea.empty(); // Xóa thông báo cũ

                    if (response.success) {
                        messageArea.append('<div class="alert alert-success">' + response.message + '</div>');
                        $('#checkout-form')[0].reset(); // Xóa dữ liệu form sau khi thanh toán thành công

                        // Chờ 3 giây rồi chuyển hướng đến trang xem đơn hàng
                        setTimeout(function () {
                            window.location.href = '/NguoiDung/XemDonHang'; // URL trang xem đơn hàng
                        }, 3000); // 3000ms = 3s
                    } else {
                        messageArea.append('<div class="alert alert-danger">' + response.message + '</div>');
                    }
                },
                error: function () {
                    $('#message-area').html('<div class="alert alert-danger">Đã xảy ra lỗi khi gửi yêu cầu. Vui lòng thử lại sau.</div>');
                }
            });
        });
    });
    </script>


</body>
</html>